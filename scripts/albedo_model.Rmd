---
title: "Algae albedo model"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(broom)
library(readxl)
library(ggpubr)
library(cowplot)
```


```{r}
# field radiometer data convolved to albedo
albedo <- read_csv(here("data/radiometer/as_bb_albedo.csv"), col_types = cols())
v_albedo <- read_csv(here("data/radiometer/as_viz_albedo.csv"), col_types = cols()) # visible albedo
nir_albedo <- read_csv(here("data/radiometer/as_nir_albedo.csv"), col_types = cols()) # NIR albedo

# algae abundance (data processed in algae abundance regression)
cc <- read_csv(here("data/cellcount/cell_long.csv"), col_types = cols()) 

# RGND
rgnd <- read_csv(here("data/radiometer/as_s2_indices.csv"), col_types = cols())

# IRF
scans <- read_csv(here("data/radiometer/sample_scans.csv"), col_types = cols())
solar_rad <- read_excel(here("data/PVL_SpectrumCalculator2.xlsx"), sheet = 3)
```

# Compare duplicate albedo scans

QC

```{r}
albedo %>% 
  mutate(sample_id = sample_id %>% str_remove("21.")) %>% 
  ggplot(aes(x=  sample_id %>% fct_reorder(albedo), y = albedo )) +
  geom_point(alpha = 0.4) +
  labs(x = "Sample ID", y = "Broadband albedo (350-1340 nm)") +
  ylim(0,1) +
  coord_flip() +
  theme_minimal()
```
Seems reasonable. Use the mean value for the rest of this analysis

# Take mean values of everything
```{r}
albedo_wide <- albedo %>% 
  group_by(sample_id) %>% 
  summarise(mean_albedo = mean(albedo), sd_albedo = sd(albedo))
albedo_wide

v_albedo_wide <- v_albedo %>% 
  group_by(sample_id) %>% 
  summarise(mean_vis_albedo = mean(albedo), sd_vis_albedo = sd(albedo))
v_albedo_wide

nir_albedo_wide <- nir_albedo %>% 
  group_by(sample_id) %>% 
  summarise(mean_nir_albedo = mean(albedo), sd_nir_albedo = sd(albedo))

all_albedo <- left_join(albedo_wide, v_albedo_wide, by = "sample_id") %>%
  left_join(nir_albedo_wide, by = "sample_id")
all_albedo
```
Make wide versions of cell count and RGND data
```{r}
cc_wide <- cc %>% 
  pivot_wider(names_from= name, values_from = c("mean", "sd"))

rgnd_wide <- rgnd %>% 
  filter(name=="rgnd") %>% 
  select(-name) %>% 
  rename(mean_rgnd = mean, sd_rgnd = sd)
```


Combine all data into a single data frame

```{r}
dirty_snow_samples <- c("bdw9", "whi10", "tri14")

# df containing all data used in this analysis
dat <- all_albedo %>% 
  left_join(cc_wide) %>% 
  left_join(rgnd_wide) %>% 
  # shorten the sample ID for plotting
  mutate(sample_id = sample_id %>% str_remove("21.0"),# Remove the 21. from the sample IDs
         sample_id = sample_id %>% str_remove("21."),
         # annotate as "white" or "dirty" or "red" snow
         type = case_when(mean_cell_area_percent <0.01 ~ "white",
                          sample_id %in% dirty_snow_samples ~ "dirty",
                          TRUE ~ "red"))
dat
```

# Compute IRF


For comparison with other studies (e.g Khan, Ganey)

Approach: multiply incoming solar radiation by delta albedo (mean white snow albedo)   

Tidy the incident solar data
```{r}
srad <- solar_rad %>% 
  clean_names() %>% 
  select(wavelength_nm, global_into_module_w_m2_nm) %>% 
  rename(wvl = wavelength_nm)

scan2 <- scans %>% # SLOW!!!!!! ~30 seconds on my laptop
    # shorten the sample ID for plotting
  mutate(sample_id = sample_id %>% str_remove("21.0"),# Remove the 21. from the sample IDs
         sample_id = sample_id %>% str_remove("21.")) %>% 
  group_by(sample_id, wvl) %>% 
  summarise(mean = mean(tgt_ref_ratio),
            sd = sd(tgt_ref_ratio)) %>% 
  ungroup()
```

get white snow mean albedo, to use as a baseline
```{r}
white_samples <- dat %>% 
  filter(type=="white") %>% 
  pull(sample_id)

white_snow_means <- scan2 %>% 
  filter(sample_id %in% white_samples) %>% 
  group_by(wvl) %>% 
  summarise(white_mean = mean(mean))
```

compute how much the dirty and red snow reduce the albedo relative to white snow 
"delta albedo"

```{r}
irfs <- scan2 %>% 
  # filter to get only the red and dirty samples
  filter(!(sample_id %in% white_samples)) %>%
  left_join(white_snow_means, by ="wvl") %>% 
  # compute delta albedo = reduction in albedo relative to white snow
  mutate(delta_albedo = white_mean - mean) %>% 
  inner_join(srad) %>% # incoming, downwelling radiation (use inner join because 10 nm bins)
  # IRF = change in albedo due to algae * downwelling radiation
  # following Ganey 2017, multiply by 10 to account for the 10 nm increments
  mutate(irf = 10 * delta_albedo * global_into_module_w_m2_nm,
         irf_sd = 10* sd * global_into_module_w_m2_nm) 

irf_full <- irfs %>% 
  # get the total IRF for each sample (sum across wavelengths)
  group_by(sample_id) %>%
  summarise(irf = sum(irf), irf_sd = sum(irf_sd)) %>% 
  left_join(dat) %>% # cell abundance metrics
  ungroup()
irf_full
```



# plot


## plot template function
```{r}
my_plot <- function(dat, x, y, xsd, ysd, formula){
  x <- enquo(x)
  y <- enquo(y)
  xsd <- enquo(xsd)
  ysd <- enquo(ysd)
  
  dat %>% 
    ggplot(aes(y = !!y, x = !!x)) +
    geom_smooth(method = "lm", se = FALSE, formula = formula, data = dat %>% filter(type=="red"), color = "#F8766D") +
    geom_point(aes(fill = type), color="black", pch = 21, size = 2.4) +
    # the Y axis SD crossbar
    geom_linerange(aes(ymin = !!y - !!ysd,
                        ymax = !!y + !!ysd),
                        alpha = 0.4) +
    # the X axis crossbar
    geom_linerange(aes(xmin = !!x - !!xsd,
                     xmax = !!x + !!xsd),
                  alpha = 0.4) +
    theme_minimal()
}
```


## A. albedo vs algae abund
```{r}
pa <- my_plot(dat, x = mean_cell_area_percent, y = mean_albedo, xsd = sd_cell_area_percent, ysd = sd_albedo, formula = y~log(x)) +
  labs(x = "Cell area % cover", y = "Broadband albedo", fill = "Snow type", tag = "A") +
  # lims(y = c(0, 1)) +
  scale_fill_manual(values = c("gray", "#F8766D", "white"))
pa
```

## B albedo vs RGND
```{r}
pb <- my_plot(dat, x = mean_rgnd, y = mean_albedo, xsd = sd_rgnd, ysd = sd_albedo, formula = y~x) +
  labs(x = "RGND", y = "Broadband albedo", fill = "Snow type", tag = "B") +
  # lims(y = c(0, 1)) +
  scale_fill_manual(values = c("gray", "#F8766D", "white"))
pb
```









## C. algae abund vs IRF


```{r}
pc <- my_plot(irf_full, x = mean_cell_area_percent, y = irf, xsd = sd_cell_area_percent, ysd = irf_sd, formula = y~log(x)) +
  labs(y = "IRF (Wm2)", x = "Cell area % coverage", fill = "Snow type", tag = "C") +
  scale_fill_manual(values = c("gray", "#F8766D"))
pc
```


## Combine panels (Fig 3)
```{r}
legend <- cowplot::get_legend(pa)

ggarrange(pa + theme(legend.position = "none"), 
          pb + theme(legend.position = "none"), 
          pc + theme(legend.position = "none"), 
          legend,
          ncol = 2, nrow = 2)
```


```{r}
# ggsave(here("figs/f3.pdf"))
```




# Regression coefficients

```{r}
# don't include white, dirty snow in models
mod_dat <- dat %>% 
  filter(type == "red")
```


## A. albedo vs algae area 
```{r}
albedo_algae_mod <- lm(mean_albedo ~ log(mean_cell_area_percent), data = mod_dat)
tidy(albedo_algae_mod)
```
Compute 95% CI
```{r}
1.96*0.032
1.96*0.010578
```
albedo = (0.66 +/- 0.063)  - 0.08 +/- 0.0207 * log(Cell Area Percent Cover)

```{r}
summary(albedo_algae_mod)$r.squared # .80
```





##B. albedo vs RGND

```{r}
albedo_rgnd_mod <- lm(mean_albedo ~ mean_rgnd, data = mod_dat)
tidy(albedo_rgnd_mod)
```
95% CI
```{r}
1.96*0.03468
1.96*0.1726
```
Excluding the intercept, the delta albedo attributable to algae is predicted by: 
delta_albedo = 0.9 +/- 0.34 RGND 

```{r}
summary(albedo_rgnd_mod)$r.squared # 0.65
```

## C. IRF vs algae area 

```{r}
irf_mod <- lm(irf ~ 0 + log(mean_cell_area_percent), data = irf_full %>% filter(type == "red"))
irf_mod %>% tidy()
```
95% CI
```{r}
1.96*3.35
```


IRF = 59 +/- 6.6 log(frac_red_percent)

```{r}
summary(irf_mod)$r.squared
```



sanity check
```{r}
log(100)*59
```


# compare IRF with Ganey, Khan

compute a 350-850 nm IRF for direct comparison with Ganey, Khan
```{r}
irf2 <- irfs %>% 
  filter(wvl>=350, wvl<=850) %>% 
  group_by(sample_id) %>%
  summarise(irf = sum(irf),
            irf_sd = sum(irf_sd)) %>% 
  left_join(dat) %>%  # cell abundance metrics
  ungroup()
```

```{r}
my_plot(irf2, x = mean_cell_area_percent, y = irf, xsd = sd_cell_area_percent, ysd = irf_sd, formula = y~log(x)) +
  labs(y = "IRF (Wm2)", x = "Cell area % coverage", fill = "Snow type", tag = "C") +
  scale_fill_manual(values = c("gray", "#F8766D"))
```
Very similar to our full albedo IRF (the NIR does not contribute much)



# Categorical comparison red, white, dirty snow


## mean values for BB, visible, NIR albedo
```{r}
dat %>% 
  select(type, contains("mean")) %>% 
  group_by(type) %>% 
  summarise_all(mean)
```


## plot


```{r}
dat %>% 
  # format for plotting
  select(type, mean_cell_area_percent, mean_albedo, mean_vis_albedo, mean_nir_albedo) %>% 
  pivot_longer(cols = c(mean_albedo, mean_vis_albedo, mean_nir_albedo)) %>% 
  ggplot(aes(y = value, x = type)) +
  facet_grid(rows = vars(name)) +
  geom_boxplot() +
  # geom_jitter(width = 0.2) +
  lims(y = c(0,1)) +
  labs(y = "Broadband albedo (350 - 1340 nm)") +
  theme_minimal()
```



## NIR albedo white vs red ANOVA
```{r}
# anova
nir_mod <- lm(mean_nir_albedo~type, data = dat %>% filter(type!="dirty"))
summary(nir_mod)
```
p=0.0146 red different from white in the NIR albedo



