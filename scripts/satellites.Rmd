---
title: "Satellite image comparison"
output: rmarkdown::github_document
---

```{r}
library(tidyverse)
library(here)
library(fs)
library(janitor)
library(lubridate)
library(zoo)
```

```{r}
ts_modis <- dir_ls(here("data/gee_ts/modis_grid_cells"), regexp = ".csv$") %>% 
  map_df(read_csv, id = "filename")

# w custom perimeter
ts_custom <- dir_ls(here("data/gee_ts/custom_polygon"), regexp = ".csv$") %>% 
  map_df(read_csv, id = "filename")

ts_glims <- dir_ls(here("data/gee_ts/glimsGeom"), regexp = ".csv$") %>% 
  map_df(read_csv, id = "filename")

srad <- dir_ls(here("data"), regexp = "*srad.csv$") %>% 
  map_df(read_csv, id = "filename")

hist <- dir_ls(here("data"), regexp = "*hist.csv$") %>% 
  map_df(read_csv, id = "filename")
```


# tidy

```{r}
# parse site name, date
my_tidy <- function(df){
  df %>% 
    clean_names() %>% 
    mutate(site = filename %>% basename() %>% str_remove(".csv") %>% str_split_n("_", 1),
           date = mdy(system_time_start))
}

# parse platform name, apply cloudmask
ts_tidy <- function(df){
  df %>% 
     mutate(platform = basename(filename) %>% 
              str_split_n("_", 2) %>% 
              str_remove(".csv"),
         rgnd = if_else(is.na(rgnd), rgnd_cloudmasked, rgnd)) %>% 
  select(platform, site, date, rgnd, albedo)
}


ts_modis_wide <- ts_modis %>% 
  my_tidy() %>% 
  ts_tidy()

ts_custom_wide <- ts_custom %>% 
  my_tidy() %>% 
  ts_tidy()

ts_glims_wide <- ts_glims %>% 
  my_tidy() %>% 
  ts_tidy()

srad_clean <- srad %>% 
  my_tidy() %>% 
  filter(date >= "2020-07-01", date < "2020-09-01") %>% 
  select(site, date, srad)

hist_clean <- hist %>% 
  clean_names() %>% 
  mutate(site = basename(filename) %>% str_split_n("_", 1), .keep = "unused")
```



Long format for plotting w albedo
```{r}
# for plotting albedo and RGND on the same axis
ts_modis_long <- ts_modis_wide %>% 
  pivot_longer(cols = c(rgnd, albedo), names_to = "band", values_drop_na = TRUE)

ts_custom_long <- ts_custom_wide %>% 
    pivot_longer(cols = c(rgnd, albedo), names_to = "band", values_drop_na = TRUE)

ts_glims_long <- ts_glims_wide %>% 
    pivot_longer(cols = c(rgnd, albedo), names_to = "band", values_drop_na = TRUE)
```




# plot

```{r}
ts_custom_long %>% 
  mutate(band = band %>% fct_relevel("rgnd")) %>% # factor RGND before albedo
  ggplot(aes(x = date, y = value, color = platform)) +
  geom_line() +
  facet_grid(rows = vars(band), cols = vars(site), scales = "free")
```
Aqua is very jumpy-- 
Dont show albedo

```{r}
plot_dat <- ts_custom_wide %>% 
  filter(platform %in% c("s2", "l8", "terra")) 

pp <- plot_dat %>% 
  ggplot(aes(x = date, y = rgnd, color = platform)) +
  facet_grid(rows = vars(site %>% fct_relevel("vowell"))) +
  # MODIS layer
  geom_point(alpha = 0.5, size = 1, data = plot_dat %>% 
              filter(platform == "terra") ) +
  # stat_smooth(method = "loess", size = 0,
  #           data = plot_dat %>% 
  #             filter(platform == "terra")) +
  # S2 and L8 layers
  # geom_line(alpha = 0.5, size = 1, data = plot_dat %>% 
  #             filter(platform %in% c("l8", "s2")) ) +
  geom_point() +
  labs(x = "Date", y = "RGND", color = "Satellite") +
  theme_minimal() +
  geom_hline(yintercept = 0) 
pp
# ggsave(here("figs/satellite_time_series.pdf"), height = 5, width = 7)
```
Odd drop in mid August on Cat, not due to clouds. Late season estimates not reliable, bare ice showing. 



 up to 0.05 on July 30, this corresponds to an estimated cell density of 2.5e8 per 31 days, or a growth rate of +8 million cells per square meter per day. 


# consensus RGND phenology

Approach: establish a "peak bloom" date for each glacier, then
take the mean RGND for each platform/site within +/- n days of the peak date. 

I will use MODIS to establish peak bloom, since there is more data. 


## apply smooth spline to Terra
```{r}
nk <- 10

terra <- ts_custom_wide %>% 
  filter(platform=="terra") %>% 
  group_by(site) %>% # split into vowell and cat time series
  mutate(yday = yday(date)) %>% 
  select(platform, site, yday, rgnd)

spl <-
  terra %>% 
  nest() %>%
  ungroup() %>% # nest automatically groups.. why?
  mutate(mod = map(data, ~smooth.spline(x=.x$yday, y=.x$rgnd, nknots = nk)),
         aug = map(mod, broom::augment)) %>% 
  unnest(cols = c(aug))

# sanity check
spl %>% 
  ggplot(aes(x = x)) +
  geom_line(aes(y = y)) +
  geom_line(aes(y = .fitted), color = "red") +
  facet_grid(rows = vars(site))
```

## get peak bloom date from terra

```{r}
max_smooth_yday <- spl %>% 
  group_by(site) %>% 
  filter(.fitted == max(.fitted)) %>% 
  select(site, x)

window <- 3 # includes

peak_data <- terra %>%
  left_join(max_smooth_yday) %>% 
  mutate(min = x - window,
         max = x + window) %>% 
  filter(yday >= min, 
         yday <= max) %>% 
  ungroup() %>% 
  select(platform, site, yday, rgnd) # rgnd is the actual data, not smoothed

peak_data %>% 
  ggplot(aes(x = yday, y= rgnd)) +
  geom_point() +
  facet_grid(rows = vars(site)) +
  geom_boxplot()
```

Peak bloom date: 
vowell 210 = Jul 29
cat 215 = Aug 3

Peak RGND (from S2)
vowell: 0.05 (7-28)
cat: 0.039 (7-30i)

Peak bloom week: (+/- 3 days of peak bloom day):

vowell	213	208	-- jul26 aug1
cat 218	212		-- jul31 aug 6

### add consensus to plot
```{r}
cons <- tibble(
  platform = "consensus",
  site = c(rep("vowell", 3), rep("cat", 3)),
  date = ymd(c("2020-07-01", "2020-07-28", "2020-09-01", "2020-07-01", "2020-07-30", "2020-09-01")),
  rgnd = c(0,0.05, 0, 0,0.039, 0)
)


pp2 <- plot_dat %>%
  mutate(platform = platform %>% 
           fct_relevel(c("s2", "l8", "terra")) %>%# order factors
           fct_recode("Sentinel-2"="s2",
                      "Landast-8"="l8",
                      "MODIS/Terra"="terra")) %>% #, # print full names
  ggplot(aes(x = date, y = rgnd, color = platform)) +
  facet_grid(rows = vars(site %>% fct_relevel("vowell"))) +
  geom_line(data = cons, color = "purple", size = 2, alpha = 0.3, lineend='round') +
  geom_point() +
  labs(x = "Date", y = "RGND", color = "Satellite") +
  theme_minimal() +
  geom_hline(yintercept = 0, alpha = 0.7) +
  theme(panel.spacing = unit(2, "lines"))

pp2

# ggsave(here("figs/final_fig5.pdf"), width = 7, height = 5)
```



## compare mean RGND estimates between satellites for peak bloom week
```{r}
# get the min/max days from the terra peak data for filtering the rest of the dataset
range <- max_smooth_yday %>% 
  mutate(max = x+window, min = x-window)

# filter the L8/S2 data to within this date range
all_peak_data <- ts_custom_wide %>% 
  filter(platform %in% c("s2", "l8")) %>% 
  mutate(yday = yday(date)) %>% 
  left_join(range, by = "site") %>%
  group_by(site, platform) %>% 
  filter(yday>=min, yday<=max) %>% 
  select(platform, site, yday, rgnd) %>% 
  # tack on the terra data
  bind_rows(peak_data) %>% 
  ungroup()
  
all_peak_data %>% 
  ggplot(aes(x = platform, y = rgnd)) +
  geom_boxplot() +
  facet_wrap(vars(site)) +
  ggtitle("peak bloom RGND estimates")
```
Sentinel > Terra > Landsat

larger grid cells, signal is dampened by more noise
The landsat had some cloud issues, disregard. 

In table format, individually
```{r}
means <- all_peak_data %>%
  group_by(platform, site) %>% 
  summarise(mean(rgnd), n(), sd(rgnd)) %>% 
  ungroup()
means
```
How much lower is Terra from S2?

```{r}
0.05 - 0.041 # 0.009
0.036 - 0.032 # 0.004
mean(c(0.009, 0.004)) # av difference

0.041/0.05 # .82
0.032/0.036 #.888
mean(c(0.888, .82))
```




The second of the three S2 images for cat had some cloud issues as well, disregard. 

Just the use the max S2 as our best estimate




# Glacier stats

## whole glacier

```{r}
# approach: take mean RGND over glacier area, apply algae abundance models, multiply by glacier area
# this should give the same result as individually summing each grid cell's algae productivity

max_algae_glims <-
  ts_glims_wide %>% 
  filter(platform == "s2") %>% 
  group_by(site) %>% 
  summarise(max_rgnd = max(rgnd, na.rm = TRUE)) %>% 
  # applying the algae abundance models
  mutate(max_frac_red = max_rgnd * 154, # percent cell area
         max_cell_density = max_rgnd * 5.4, # bil cells / m2
         max_toc = 12.9*max_rgnd, # g/m2
         max_tn = 376*max_rgnd, # mg/m2
         max_delta_albedo = 0.88 * max_rgnd, # on the whole glacier
         glacier_area_m2 = c(5.85e6, 6.04e6), # m2
         total_cells = max_cell_density * glacier_area_m2 * 1e9, 
         total_toc_kg = (max_toc * glacier_area_m2)/1000, # convert from g to kg
         total_tn_kg = (max_tn * glacier_area_m2)/(1000*1000)) # convert from mg to kg
         
max_algae_glims %>% arrange(max_delta_albedo)
```
At peak bloom:
Vowell: 2.5% coverage, albedo -1.4%, 1245 kg TOC and 36 kg TN
Catamount: 3.2% coverage, albedo -1.8%, 1585 kg TOC, 46 kg TN


Applying G-D melt model, algae melt = 0.13 sqrt(area in cm2/l)

```{r}
melt <- function(rgnd){
  cell_dens <- rgnd * 1234 # my model, in cm2/L
  0.13*sqrt(cell_dens)
}
melt(0.016) # vowell
melt(0.021) # cat
```



Is the estimated delta albedo reasonable? check the MODIS albedo data
```{r}
ts_glims_wide %>% 
  filter(date<"2020-09-01") %>% 
  drop_na(albedo) %>% 
  ggplot(aes(x = date, y = albedo)) +
  geom_point() +
  facet_grid(rows = vars(site)) #+
  # geom_smooth(method = "lm", se = FALSE)
```
The first point in July is ~0.5. The last points in late July oscillate around 0.4. 
so let's say MODIS estimates a delta albedo of 0.5 - 0.4 = 0.1 (July), or 10%

This is much higher than our estimate of 1-2%, but we would expect some decline in albedo in the absence of snow algae. so 8-9% albedo decline is due to snowmelt?


### radiative forcing



Approximate bloom density as abs function to integrate RF over the summer (Jul - Aug)
```{r}
my_site <- "cat"

max_delta_albedo <- max_algae_glims %>% 
  filter(site == my_site) %>% 
  pull(max_delta_albedo)



# delta_albedo_approx %>% ggplot(aes(x = date, y= delta_albedo)) + geom_line()
# srad_clean %>% ggplot(aes(x = date, y = srad)) + geom_line() +facet_grid(rows = vars(site))

srad_clean %>% 
  filter(site==my_site) %>% 
  select(date, srad) %>% 
  left_join(delta_albedo_approx, by = "date") %>% 
  mutate(rf = srad * delta_albedo) %>% 
  summarise(rf = mean(rf))
  
```

Vowell bloom has a RF of 2.98 W/m2 from July - August averaged over the entire glacier area
Cat was 3.85


## just the "bloom area"

```{r}
max_algae_custom <-
  ts_custom_wide %>% 
  filter(platform == "s2") %>% 
  group_by(site) %>% 
  summarise(max_rgnd = max(rgnd, na.rm = TRUE)) %>% 
  # applying the algae abundance models
  mutate(max_frac_red = max_rgnd * 154, # percent cell area
         max_cell_density = max_rgnd * 5.4, # bil cells / m2
         max_toc = 12.9*max_rgnd, # g/m2
         max_tn = 376*max_rgnd, # mg/m2
         max_delta_albedo = 0.88 * max_rgnd, 
         bloom_area_m2 = c(1.9e6, 2e6), # m2
         total_cells = max_cell_density * bloom_area_m2 * 1e9, 
         total_toc_kg = (max_toc * bloom_area_m2)/1000, # convert from g to kg
         total_tn_kg = (max_tn * bloom_area_m2)/(1000*1000)) # convert from mg to kg
         
max_algae_custom %>% arrange(max_delta_albedo)
```

delta albedo is the amount by which our RGND-albedo model predicts snow algae to decrease albedo (Fig 3B)



total abundance:
bloom polygon likely underestimate (boundaries too small)
glacier polygon likely overestimate of total prod (false positives)



```{r}
melt(0.05)# 10.2 mm SWE/day
melt(0.039) #9 mm SWE/day
```
1 cm water over the entire bloom polygon area, is a volume of 
```{r}
# in units of m2 and m
1.6e6*0.012 # 19,000 m3/day
2.1e6*0.009 # 19,000 m3 per day
```



Compare to the MODIS albedo (using the custom polygon)

```{r}
ts_custom_wide %>% 
  filter(date<"2020-08-01", date>"2020-07-01") %>% 
  drop_na(albedo) %>% 
  ggplot(aes(x = date, y = albedo)) +
  geom_point() +
  facet_grid(rows = vars(site)) +
  ggtitle("bloom area, MODIS albedo") +
  geom_smooth(method="lm", se=FALSE)
```
also looks like a 10% drop in albedo in July. But this is very few grid cells, at this resolution hard to say. If our model predicts a drop of ~4%. 
snowdepth could effect this. showing dark ice beneath. 
What was the depth under our albedo measurements? but three sites should average this out...


## fill in missing vals from consensus

expand
```{r}
cons2 <- cons %>% # from consensus for bloom polygon
  complete(site, date = seq(min(date), max(date), by = "day")) %>% 
  group_by(site) %>% 
  mutate(platform = "consensus",
         rgnd = zoo::na.approx(rgnd),
         delta_albedo = 0.88 * rgnd)
cons2
```

Radiative forcing estimate for bloom polygon
```{r}
srad_clean %>% 
  select(date, srad) %>% 
  left_join(cons2, by = "date") %>% 
  mutate(rf = srad * delta_albedo) %>% 
  group_by(site) %>% 
  summarise(rf = mean(rf))
  
```
Just over the bloom area, RF of 9.3 and 7.2 over vowell and catamount blooms respectively from Jul-Aug




## MODIS polygons

Compare the MODIS albedo vs the predicted algae albedo effect (delta albedo)
Might be less of a discrepancy omitting the MODIS grid cells that overlap with seasonal snow cover off the glacier

```{r}
ts_modis_wide %>% 
  filter(date<"2020-08-01", date>"2020-07-01") %>% 
  drop_na(albedo) %>% 
  ggplot(aes(x = date, y = albedo)) +
  geom_point() +
  facet_grid(rows = vars(site)) +
  ggtitle("modis area, MODIS albedo") +
  geom_smooth(method="lm", se=FALSE)
```
This looks pretty much the same

```{r}
max_algae_modis <- ts_modis_wide %>% 
  filter(platform %>% str_detect( "s2")) %>% # forgot to clip off the ".csv"
  group_by(site) %>% 
  summarise(max_rgnd = max(rgnd, na.rm = TRUE)) %>% 
  # applying the algae abundance models
  mutate(max_frac_red = max_rgnd * 154, # percent cell area
         max_cell_density = max_rgnd * 5.4, # bil cells / m2
         max_toc = 12.9*max_rgnd, # g/m2
         max_tn = 376*max_rgnd, # mg/m2
         max_delta_albedo = 0.88 * max_rgnd, 
         bloom_area_m2 = c(1.9e6, 2e6), # m2
         total_cells = max_cell_density * bloom_area_m2 * 1e9, 
         total_toc_kg = (max_toc * bloom_area_m2)/1000, # convert from g to kg
         total_tn_kg = (max_tn * bloom_area_m2)/(1000*1000)) # convert from mg to kg
         
max_algae_modis %>% arrange(max_delta_albedo)
```
Same... 


# compare custom polygon with MODIS grid cells


```{r}
compare <- ts2_wide %>% 
  rename(rgnd_custom_poly = rgnd, albedo_custom_poly = albedo) %>% 
  left_join(ts_wide)

compare %>% 
  ggplot(aes(x = rgnd, y = rgnd_custom_poly)) +
  geom_point() +
  facet_wrap(vars(platform, site), scales = "free")
```




# RGND histogram (s2 density plot)
```{r}
grid_cell_count <- hist_clean %>% 
  group_by(site) %>% 
  summarise(grid_cell_count = sum(rgnd_count, na.rm = TRUE))
grid_cell_count

hist_clean %>% 
  drop_na(rgnd_count) %>% # remove empty bins
  left_join(grid_cell_count) %>% 
  mutate(percent_algae_area = (rgnd_count / grid_cell_count) *100) %>% 
  ggplot(aes(x = band_value, y = percent_algae_area)) +
  geom_line() +
  facet_grid(rows = vars(site)) +
  labs(y = "% algae area", x = "RGND")
```
```{r}
# reverse engineer the raw obs, hacky
raw_vals_vec_cat <- hist_clean %>% 
  filter(site == "cat") %>% 
  drop_na(rgnd_count) %>% 
  rowwise() %>% 
  mutate(reps = list(rep(band_value, rgnd_count))) %>% # ->x;x[9,4] %>% pull() # sanity check
  select(reps) %>% 
  unlist() # as list

raw_vals_vec_vowell <- hist_clean %>% 
  filter(site == "vowell") %>% 
  drop_na(rgnd_count) %>% 
  rowwise() %>% 
  mutate(reps = list(rep(band_value, rgnd_count))) %>% # ->x;x[9,4] %>% pull() # sanity check
  select(reps) %>% 
  unlist() # as list

raw_vals_tbl <- tibble(rgnd = c(raw_vals_vec_cat, raw_vals_vec_vowell),
                       site = c(rep("cat", length(raw_vals_vec_cat)), 
                                rep("vowell", length(raw_vals_vec_vowell))) )

raw_vals_tbl %>% 
  group_by(site) %>% 
  summarise(mean = mean(rgnd), max = max(rgnd), min = min(rgnd), sd = sd(rgnd)) %>% 
  mutate(mean_cell_percent = mean * 154, 
         mean_toc = 12.9*mean,
         mean_cell = mean * 5.4*mean)

# # santiy check: compute mean manually from the histogram data
# hist_clean %>% 
#   drop_na(rgnd_count) %>% 
#   left_join(grid_cell_count) %>% 
#   group_by(site) %>% 
#   mutate(weighted = band_value*rgnd_count) %>% 
#   summarise(mean = sum(weighted)/grid_cell_count) %>% 
#   distinct() # cat is 0.034, vowell is 0.06

```

~99% (2 SD) of values from 0 to 0.12 (vowell), and -0.005 to 0.075
0.06-0.03*2
0.035-0.02


During our Catamount transect we observed small patches of concentrated red snow ~10-100 cm wide interspersed on white snow (Supp), but this patchiness was less apparent in Sentinel-2 images due to 10 m spatial resolution






# scratch





```{r, fig.width = 8, fig.height= 3}
p1_dat <- ts_long %>% 
  filter(band=="rgnd_mean", !(platform %in% c("aqua8", "terra8", "aqua"))) %>% # only show the 8 day MODIS composite
  mutate(platform = case_when(#platform == "aqua" ~ "Aqua", # (8 day)
                              platform == "l8" ~ "Landsat-8",
                              platform == "s2" ~ "Sentinel-2",
                              platform == "terra" ~ "Terra"),
                              # platform == "terra8" ~ "Terra",
                              # platform == "aqua8" ~ "Aqua"),
         platform = platform %>% fct_relevel("Sentinel-2", "Landsat-8", "Terra"),#, "Aqua"), #"Aqua (8 day)", "Terra (8 day)"
         name = name %>% str_to_title(),
         frac_red = (-0.02 + 2.25 * mean)*100,
         toc_g_per_m2 = 0.176 + 15.8 * mean,
         frac_red = ifelse(frac_red<0, 0, frac_red),
         toc_g_per_m2 = ifelse(toc_g_per_m2<0, 0, toc_g_per_m2),
         )

p1 <- p1_dat %>% 
  # remove the low outlier in landsat-8
  # filter(!(platform=="Landsat-8" & name == "Catamount" & date>ymd("2020-08-17") & date<ymd("2020-08-19"))) %>% 
  # remove the high outliers
  filter(frac_red<10) %>%
  ggplot(aes(x = date, y = frac_red, color = platform)) +
  # geom_line(alpha = 1) +
  # geom_smooth(se=FALSE) +
  # geom_smooth(method = "gam", se=FALSE, formula = y ~ s(x, bs = "tp"), # increase wiggliness of spline?
              # data = p1_dat %>% filter(platform != "Landsat-8")) +
  facet_grid(cols = vars(name)) +
  labs(y = "Percent snow algae cell coverage", x = "", color = "Satellite") +
  theme_minimal()
p1
ggsave(here("figs/time_series.pdf"), height=3, width=12)
```
LOESS might work if we can filter out the 0's (cloudy images)
set df to n-1 for each group? 

```{r, fig.width = 8, fig.height= 3}
p1_dat %>% 
  ggplot(aes(x = date, y = toc_g_per_m2, color = platform)) +
  geom_line() +
  # geom_point(alpha = 0.5) + 
  facet_grid(cols = vars(name)) +
  labs(y = "Total organic carbon (g/m2)", x = "", color = "Satellite") +
  theme_minimal()
```


```{r}
# nk <- 10
# 
# # splines <- 
#   ts_wide %>%
#   group_by(name, platform) %>%
#   select(rgnd_mean, albedo_mean) %>% 
#   nest() %>%
#   ungroup() %>%
#   mutate(mod = map(data, ~smooth.spline(x=.x$wvl, y=.x$tgt_ref_ratio, nknots = nk)),
#          aug = map(mod, broom::augment))
# 
# # plot a sample
# set.seed(123)
# splines %>%
#   slice_sample(n=10) %>%
#   unnest(cols = c(aug)) %>%
#   ggplot(aes(x = x)) +
#   geom_line(aes(y = y, group = scan_id)) +
#   geom_line(aes(y = .fitted, group = scan_id), color = "red") 
# 
# # plot all
# splines %>%
#   unnest(cols = c(aug)) %>%
#   ggplot(aes(x = x)) +
#   geom_line(aes(y = y, group = scan_id)) +
#   geom_line(aes(y = .fitted, group = scan_id), color = "red")
```

```{r, fig.width = 8, fig.height= 3}
nk <- 10

albedo_long <- tidied %>% 
  filter(band=="albedo_mean") %>% 
  mutate(platform = platform %>% str_split_n("_", 1) %>% str_to_title(),
         name = name %>% str_to_title()) %>% 
  select(-band) # no NAs-- smooth.spine cannot handle NA

test <- albedo_long %>% 
  filter(name == "Catamount", platform == "Terra") %>% 
  select(date, mean)

smooth.spline(test, nknots = nk) %>%
  augment(test) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = mean)) +
  geom_line(aes(y = .fitted), color = "red")
```


```{r, fig.width = 8, fig.height= 3}
smooth_albedo <- function(site, sat){
  twoCol <- albedo_long %>% 
    filter(name == site, platform == sat) %>% 
    select(date, mean)

  smooth.spline(twoCol, nknots = nk) %>%
    augment(twoCol) %>%
    add_column(name = site, platform = sat, .before = 1)
}
catamount_aqua_albedo <- smooth_albedo("Catamount", "Aqua")
catamount_terra_albedo <- smooth_albedo("Catamount", "Terra")
vowell_aqua_albedo <- smooth_albedo("Vowell", "Aqua")
vowell_terra_albedo <- smooth_albedo("Vowell", "Terra")

albedo_splines <- bind_rows(catamount_aqua_albedo,catamount_terra_albedo,vowell_aqua_albedo,vowell_terra_albedo)
```

use the same colors as before to plot satellites
```{r}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
 # +
 #  scale_color_manual(values = gg_color_hue(4)[3:4]) # aqua and terra
```


```{r, fig.width = 8, fig.height= 3}
# plot all
albedo_splines %>%
  filter(platform=="Terra") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = mean), alpha = 0.2) + # raw
  # geom_line(aes(y = .fitted, group = platform)) + # gam
  geom_smooth(aes(y = mean), se = FALSE, color =gg_color_hue(3)[3]) + # LOESS
  facet_grid(cols = vars(name)) +
  labs(y = "Terra Albedo", x = "") +
  theme_minimal()

ggsave(here("figs/albedo_ts.pdf"), height=3, width=12 )
```


Can we re-create MODIS albedo by estimating from RGND?

```{r}

```

